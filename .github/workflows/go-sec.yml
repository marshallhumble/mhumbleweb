name: Security Scan (Gosec)

on:
  push:
    branches: [main, master]  # Support both common branch names
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 1'  # Run weekly on Mondays at 2 AM
  workflow_dispatch:  # Allow manual triggering

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for uploading SARIF results
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # Updated to v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'

      - name: Upload SARIF file to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()  # Upload even if scan finds issues
        with:
          sarif_file: gosec-results.sarif

      - name: Upload Gosec results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gosec-results
          path: gosec-results.sarif

      - name: Check for security issues
        run: |
          if [ -f gosec-results.sarif ]; then
            # Count issues in SARIF file
            ISSUES=$(jq '.runs[0].results | length' gosec-results.sarif 2>/dev/null || echo "0")
            echo "Security issues found: $ISSUES"
          
            if [ "$ISSUES" -gt 0 ]; then
              echo "âš ï¸ Security issues detected. Check the Security tab for details."
              echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
              echo "- **Issues found:** $ISSUES" >> $GITHUB_STEP_SUMMARY
              echo "- **Details:** Check the Security tab in your repository" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No security issues found"
              echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
              echo "- **Status:** âœ… No security issues detected" >> $GITHUB_STEP_SUMMARY
            fi
          fi